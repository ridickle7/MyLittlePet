package yapp.co.kr.mlp.component;

import android.app.Activity;
import android.app.DatePickerDialog;
import android.content.Context;
import android.content.Intent;
import android.content.res.AssetFileDescriptor;
import android.database.Cursor;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.location.Address;
import android.location.Geocoder;
import android.net.Uri;
import android.os.AsyncTask;
import android.os.Bundle;
import android.provider.MediaStore;
import android.support.v7.app.ActionBarActivity;
import android.util.Log;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.widget.Button;
import android.widget.DatePicker;
import android.widget.EditText;
import android.widget.ImageButton;
import android.widget.ImageView;
import android.widget.RadioGroup;
import android.widget.Toast;

import com.android.volley.AuthFailureError;
import com.android.volley.NetworkError;
import com.android.volley.NoConnectionError;
import com.android.volley.ParseError;
import com.android.volley.Request;
import com.android.volley.RequestQueue;
import com.android.volley.Response;
import com.android.volley.ServerError;
import com.android.volley.TimeoutError;
import com.android.volley.VolleyError;
import com.android.volley.toolbox.ImageRequest;
import com.android.volley.toolbox.StringRequest;
import com.google.android.gms.vision.barcode.Barcode.GeoPoint;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.DefaultHttpClient;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import yapp.co.kr.mlp.Helper.ImageHelper;
import yapp.co.kr.mlp.Helper.MySingleton;
import yapp.co.kr.mlp.Item_item.Qna;
import yapp.co.kr.mlp.R;

public class EditActivity extends ActionBarActivity {
    //발리 테스트용
    ArrayList<Qna> abList;
    int item_num = 0;
    Qna ne1;
    RequestQueue mQueue2;

    ImageButton ok, cancel, upload;
    ImageView image;
    Bitmap image_bitmap;
    RadioGroup pet_gender, user_gender;
    EditText pet_name,  pet_age, pet_specific, pet_introduction_write, user_nickname, user_age;
    Button pet_birthday, user_location;
    final int REQ_CODE_SELECT_IMAGE = 100;
    Context ctx = this;


    int version_code = 1;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_edit);

        like();
        like_post();
        init();
        listener();

        String findAddress="서울시 성북구 장위1동";
        new geoPointTask().execute(findAddress);
    }

    //findViewById 모아둠
    public void init() {
        ok = (ImageButton) findViewById(R.id.ok);
        cancel = (ImageButton) findViewById(R.id.cancel);

        image = (ImageButton) findViewById(R.id.image);
        pet_name = (EditText) findViewById(R.id.pet_name);
        pet_gender = (RadioGroup) findViewById(R.id.pet_gender);
        pet_birthday = (Button) findViewById(R.id.pet_birthday);
        pet_age = (EditText) findViewById(R.id.pet_age);
        pet_specific = (EditText) findViewById(R.id.pet_specific);
        pet_introduction_write = (EditText) findViewById(R.id.pet_introduction_write);

        user_nickname = (EditText) findViewById(R.id.user_nickname);
        user_gender = (RadioGroup) findViewById(R.id.user_gender);
        user_age = (EditText) findViewById(R.id.user_age);
        user_location = (Button) findViewById(R.id.user_location);
    }

    //클릭 리스너 모아둠
    public void listener() {
        //등록 누를 시
        ok.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                //만약 첫 가입일시 -> 메인화면으로 넘어감 (처음 시작한 사람)   -   토스트로 띄워주기

                //이전에 가입한 사람일 시 -> 이것도 그냥 메인화면으로 넘어감    -   토스트로 띄워주기
            }
        });

        //취소 누를 시
        cancel.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                finish();
            }
        });

        //사진 업로드
        image.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                //버튼 클릭시 처리로직
                Intent intent = new Intent(Intent.ACTION_PICK);
                intent.setType(android.provider.MediaStore.Images.Media.CONTENT_TYPE);
                intent.setData(android.provider.MediaStore.Images.Media.EXTERNAL_CONTENT_URI);
                startActivityForResult(intent, REQ_CODE_SELECT_IMAGE);
            }
        });

        //라디오그룹 (성별)
        user_gender.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener() {
            @Override
            public void onCheckedChanged(RadioGroup group, int checkedId) {
                switch (checkedId) {
                    case R.id.user_male:
                        break;

                    case R.id.user_female:
                        break;

                    default:
                        break;
                }
            }
        });

        final DatePickerDialog.OnDateSetListener listener = new DatePickerDialog.OnDateSetListener() {
            @Override
            public void onDateSet(DatePicker view, int year, int monthOfYear, int dayOfMonth) {
                Toast.makeText(getApplicationContext(), year + "년" + (monthOfYear + 1) + "월" + dayOfMonth + "일", Toast.LENGTH_SHORT).show();
                pet_birthday.setText(year + "-" + (monthOfYear + 1) + "-" + dayOfMonth);
            }
        };

        //생일 리스너
        pet_birthday.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                Date today = new Date();
                int year = today.getYear() + 1900;
                int month = today.getMonth();
                int date = today.getDate();
                Log.d("년도", year + " " + month + " " + date + "");
                DatePickerDialog dialog = new DatePickerDialog(ctx, listener, year, month, date);

                dialog.show();
            }
        });
    }


    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        // Inflate the menu; this adds items to the action bar if it is present.
        getMenuInflater().inflate(R.menu.menu_edit, menu);
        return true;
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        // Handle action bar item clicks here. The action bar will
        // automatically handle clicks on the Home/Up button, so long
        // as you specify a parent activity in AndroidManifest.xml.
        int id = item.getItemId();

        //noinspection SimplifiableIfStatement
        if (id == R.id.action_settings) {
            return true;
        }

        return super.onOptionsItemSelected(item);
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {


        Toast.makeText(getBaseContext(), "resultCode : " + resultCode, Toast.LENGTH_SHORT).show();

        if (requestCode == REQ_CODE_SELECT_IMAGE) {
            if (resultCode == Activity.RESULT_OK) {
                try {
                    //Uri에서 이미지 이름을 얻어온다.
                    //String name_Str = getImageNameToUri(data.getData());

                    //이미지 데이터를 비트맵으로 받아온다.
                    ImageHelper help = new ImageHelper();


                    //image.setImageBitmap(help.decodeSampledBitmapFromResource(this.getResources(), R.id.image, 100, 100));
                    //option.inSampleSize = 2;
                    //image_bitmap 	= MediaStore.Images.Media.getBitmap(getContentResolver(), data.getData());

                    AssetFileDescriptor afd = getContentResolver().openAssetFileDescriptor(data.getData(), "r");
                    BitmapFactory.Options opt = new BitmapFactory.Options();
                    opt.inSampleSize = 4;
                    image_bitmap = BitmapFactory.decodeFileDescriptor(afd.getFileDescriptor(), null, opt);
                    image_bitmap = Bitmap.createScaledBitmap(image_bitmap, 640, 480, false);

                    //배치해놓은 ImageButton에 set
                    image.setImageBitmap(image_bitmap);


                    //Toast.makeText(getBaseContext(), "name_Str : "+name_Str , Toast.LENGTH_SHORT).show();


                } catch (FileNotFoundException e) {
                    // TODO Auto-generated catch block
                    e.printStackTrace();
                } catch (IOException e) {
                    // TODO Auto-generated catch block
                    e.printStackTrace();
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }
    }

    //Uri 에서 파일명을 추출하는 로직
    public String getImageNameToUri(Uri data) {
        String[] proj = {MediaStore.Images.Media.DATA};
        Cursor cursor = managedQuery(data, proj, null, null, null);
        int column_index = cursor.getColumnIndexOrThrow(MediaStore.Images.Media.DATA);

        cursor.moveToFirst();

        String imgPath = cursor.getString(column_index);
        String imgName = imgPath.substring(imgPath.lastIndexOf("/") + 1);

        return imgName;
    }


    public void like() {
        // 서버에 뉴스피드 정보 요청
        final String URL_address = "http://192.168.0.28:3000/mypage/kim";
        final String imgURL_address = "http://imgnews.naver.com/image/092/2015/04/30/1JoQeLJIa9nBJ2F5n5Bu_99_20150430111706.jpg";
        //mQueue2 = Volley.newRequestQueue(this);       //싱글턴 사용 안할 시
        mQueue2 = MySingleton.getInstance(this.getApplicationContext()).
                getRequestQueue();

        // Request a string response from the provided URL.
        // 2) Request Obejct인 StringRequest 생성
        StringRequest stringRequest = new StringRequest(Request.Method.GET, URL_address,
                new Response.Listener<String>() {
                    @Override
                    public void onResponse(String response) {
                        // Display the first 500 characters of the response string.
                        Log.d("Response is: ", response.toString());
                        Toast.makeText(getApplicationContext(), response.toString(), Toast.LENGTH_LONG);
                    }
                }, new Response.ErrorListener() {
            @Override
            public void onErrorResponse(VolleyError error) {
                if (error instanceof TimeoutError) {
                    Log.d("error", error.toString());
                }
                // 네트워크 연결이 모두 끊어진 경우
                else if (error instanceof NoConnectionError) {
                    Log.d("error", error.toString());
                } else if (error instanceof AuthFailureError) {
                    Log.d("error", error.toString());
                }
                // 서버에러, URL에 해당 자료가 없어도 이곳이 불린다.
                else if (error instanceof ServerError) {
                    Log.d("error", error.toString());
                } else if (error instanceof NetworkError) {
                    Log.d("error", error.toString());
                } else if (error instanceof ParseError) {
                    Log.d("error", error.toString());
                }
            }
        });


        Response.Listener<Bitmap> image_listener = new Response.Listener<Bitmap>() {
            @Override
            public void onResponse(Bitmap arg0) {
                // TODO Auto-generated method stub
                image.setImageBitmap(arg0);
            }
        };
        Response.ErrorListener image_err_listener = new Response.ErrorListener() {
            public void onErrorResponse(VolleyError error) {
                image.setImageResource(R.mipmap.ic_launcher);
            }
        };

        //ImageRequest는 익명 리스너 사용이 안된다.
        ImageRequest imageRequest = new ImageRequest(imgURL_address,image_listener, 0, 0, null,image_err_listener);

        // 3) 생성한 StringRequest를 RequestQueue에 추가
        //mQueue2.add(stringRequest);   //싱글턴 사용 안할 시
        MySingleton.getInstance(this).addToRequestQueue(stringRequest);
        MySingleton.getInstance(this).addToRequestQueue(imageRequest);
    }


    public void like_post() {
        // 서버에 뉴스피드 정보 요청
        final String URL_address = "http://192.168.0.28:3000/mypage";
        final String imgURL_address = "http://imgnews.naver.com/image/092/2015/04/30/1JoQeLJIa9nBJ2F5n5Bu_99_20150430111706.jpg";
        //mQueue2 = Volley.newRequestQueue(this);       //싱글턴 사용 안할 시
        mQueue2 = MySingleton.getInstance(this.getApplicationContext()).
                getRequestQueue();

        // Request a string response from the provided URL.
        // 2) Request Obejct인 StringRequest 생성
        StringRequest stringRequest = new StringRequest(Request.Method.POST, URL_address,
                new Response.Listener<String>() {

                    @Override
                    public void onResponse(String response) {
                        // Display the first 500 characters of the response string.
                        Log.d("Response is: ", response.toString());
                        Toast.makeText(getApplicationContext(), response.toString(), Toast.LENGTH_LONG);
                    }
                }, new Response.ErrorListener() {
            @Override
            public void onErrorResponse(VolleyError error) {
                if (error instanceof TimeoutError) {
                    Log.d("error", error.toString());
                }
                // 네트워크 연결이 모두 끊어진 경우
                else if (error instanceof NoConnectionError) {
                    Log.d("error", error.toString());
                } else if (error instanceof AuthFailureError) {
                    Log.d("error", error.toString());
                }
                // 서버에러, URL에 해당 자료가 없어도 이곳이 불린다.
                else if (error instanceof ServerError) {
                    Log.d("error", error.toString());
                } else if (error instanceof NetworkError) {
                    Log.d("error", error.toString());
                } else if (error instanceof ParseError) {
                    Log.d("error", error.toString());
                }
            }
        }){
            @Override
            protected Map<String, String> getParams() throws AuthFailureError {

                Map<String, String> map = new HashMap<String, String>();
                map.put("userid", "a");
                map.put("content", "b");
                map.put("userid", "c");
                map.put("title", "a");
                map.put("content", "b");
                map.put("userid", "c");
                map.put("title", "a");
                map.put("content", "b");
                map.put("userid", "c");
                return map;
            }
        };


        Response.Listener<Bitmap> image_listener = new Response.Listener<Bitmap>() {
            @Override
            public void onResponse(Bitmap arg0) {
                // TODO Auto-generated method stub
                image.setImageBitmap(arg0);
            }
        };
        Response.ErrorListener image_err_listener = new Response.ErrorListener() {
            public void onErrorResponse(VolleyError error) {
                image.setImageResource(R.mipmap.ic_launcher);
            }
        };

        //ImageRequest는 익명 리스너 사용이 안된다.
        ImageRequest imageRequest = new ImageRequest(imgURL_address,image_listener, 0, 0, null,image_err_listener);

        // 3) 생성한 StringRequest를 RequestQueue에 추가
        //mQueue2.add(stringRequest);   //싱글턴 사용 안할 시
        MySingleton.getInstance(this).addToRequestQueue(stringRequest);
        MySingleton.getInstance(this).addToRequestQueue(imageRequest);
    }



    private GeoPoint findGeoPoint(String address) {
        Geocoder geocoder = new Geocoder(this);
        Address addr;
        GeoPoint location = null;
        try {
            List<Address> listAddress = geocoder.getFromLocationName(address, 1);
            if (listAddress.size() > 0) { // 주소값이 존재 하면
                addr = listAddress.get(0); // Address형태로
                int lat = (int) (addr.getLatitude() * 1E6);
                int lng = (int) (addr.getLongitude() * 1E6);
                location = new GeoPoint(version_code,lat,lng);

                Log.d("TAG", "주소로부터 취득한 위도 : " + lat + ", 경도 : " + lng);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        return location;
    }

    private class geoPointTask extends AsyncTask<String, Void, Void> {
        @Override
        protected void onPreExecute() {
            super.onPreExecute();
        }

        @Override
        protected Void doInBackground(String... params) {
            getGeoPoint(getLocationInfo(params[0].replace("\n", " ")
                    .replace(" ", "%20")));  //주소를 넘겨준다(공백이나 엔터는 제거합니다)

            return null;
        }


        @Override
        protected void onPostExecute(Void result) {

        }
    }

    public static JSONObject getLocationInfo(String address) {

        HttpGet httpGet = new HttpGet(
                "http://maps.google.com/maps/api/geocode/json?address="
                        + address + "&ka&sensor=false");
//해당 url을 인터넷창에 쳐보면 다양한 위도 경도 정보를 얻을수있다(크롬 으로실행하세요)
        HttpClient client = new DefaultHttpClient();
        HttpResponse response;
        StringBuilder stringBuilder = new StringBuilder();

        try {
            response = client.execute(httpGet);
            HttpEntity entity = response.getEntity();
            InputStream stream = entity.getContent();
            int b;
            while ((b = stream.read()) != -1) {
                stringBuilder.append((char) b);
            }
        } catch (ClientProtocolException e) {
        } catch (IOException e) {
        }

        JSONObject jsonObject = new JSONObject();
        try {
            jsonObject = new JSONObject(stringBuilder.toString());
        } catch (JSONException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }

        return jsonObject;
    }


    public static void getGeoPoint(JSONObject jsonObject) {


        Double lon = new Double(0);
        Double lat = new Double(0);

        try {
            lon = ((JSONArray) jsonObject.get("results")).getJSONObject(0)
                    .getJSONObject("geometry").getJSONObject("location")
                    .getDouble("lng");

            lat = ((JSONArray) jsonObject.get("results")).getJSONObject(0)
                    .getJSONObject("geometry").getJSONObject("location")
                    .getDouble("lat");

        } catch (JSONException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }


        Log.d("myLog", "경도:" + lon ); //위도/경도 결과 출력
        Log.d("myLog", "위도:" + lat  );

    }
}

